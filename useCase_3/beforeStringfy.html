<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>View Photos on Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="exif.js"></script>
<style>
  body {padding: 0; margin: 0}
  html, body, #map {height: 100%; width: 100%}
  .caption {font-weight: bold}
  .leaflet-popup-content {width: 200px;}
  .thumbnail {max-width:200px; max-height:200px}
</style>
</head>
<body>
<div style="text-align:right;">
<input id="save" type="button" value="saveCange">
</div>
<div id="map"></div>
<script>
function boundaryBox(feats) {
	var xMin = 180;
	var xMax =   0;
	var yMin =  90;
	var yMax =   0;
	feats.forEach(feat => {
		var xy = feat.geometry.coordinates;
		var x  = xy[0];
		var y  = xy[1];
		if(x < xMin) xMin = x;
		if(x > xMax) xMax = x;
		if(y < yMin) yMin = y;
		if(y > yMax) yMax = y;
	});
	return [[xMin, yMin], [xMax, yMax]];
}
var btn = document.getElementById("save");
btn.disabled = true;
btn.addEventListener("click", () => {
	var contents  = "var geojson=";
	    contents += JSON.stringify(geojson, "", 2)
	var blob = new Blob([contents], {type: "text.plain"});
	var a = document.createElement("a");
	document.body.appendChild(a);
	a.href = URL.createObjectURL(blob);
	a.download = "exif.js";
	a.style = "display: none";
	a.click();
	URL.revokeObjectURL(a.href);
	btn.disabled = true;
});
var map = L.map("map");
L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
  attribution: "<a href=\'https://maps.gsi.go.jp/development/ichiran.html\' target=\'_blank\'>地理院タイル</a>"
}).addTo(map);
bbox = geojson.bbox;
southWest = [bbox[0][1], bbox[0][0]];
northEast = [bbox[1][1], bbox[1][0]];
map.fitBounds([southWest, northEast]);
L.geoJSON(geojson)
  .bindPopup((layer) => {
    var prop = layer.feature.properties;
    var img  = prop.img;
    var html = "<input type=\'text\'' id=\'caption\' value=\'" +
      prop.caption + "\' class=\'caption\' placeholder=\'--caption--\''>"
    html += "<p>" + prop.time + "</p>";
    html += "<a href=\'" + img + "\' target=\'_blank\' download>";
    html += "<img class=\'thumbnail\' src=\'" + img + "\'></a>";
    return html;
  })
  .on("popupclose", function(ev) {
    var elem = document.getElementById("caption");
    if(elem) {
      var caption = elem.value;
      var properties = ev.layer.feature.properties;
      if(properties.caption != caption) {
        properties.caption = caption;
        btn.disabled = false;
      }
    }
  })
  .addTo(map);
</script>
</body>
</html>